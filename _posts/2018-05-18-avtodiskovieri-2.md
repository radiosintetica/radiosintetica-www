---
layout: post
title: Автодисковери
tags: [astra,zabbix]
---
<!-- more -->

@svk_drew подпилил мои костыли для заббикса: - теперь там есть автодискавери и DVB!


` Коллектор astra_mon + app.py - добавлены новые роуты.`

`- /cfg_channels/ - выводит json с данными каналов, которые передала астра во время запуска потоков имеется информация о канале (название, ид, тип и т.п.)`

`- /cfg_dvbs/ - тоже самое, только для DVB адаптеров - первоначальная информация об адаптерах.
`

`- /channels/ - так и осталось - информация мониторинга всех каналов сразу`

`- /dvbs/ - информация мониторинга по всем адаптерам`

`- /channel/{id канала} - данные по конкретному каналу`

`- /dvb/{id адаптера} - по конкретному адаптеру`

`Скрипты для заббикса (скрипты тестировались на python 3.2.3. в архиве так же версия для питон выше 3.5) размещаем в /usr/lib/zabbix/externalscripts/
`

` - astra_discovery - скрипт обнаружения каналов или адаптеров dvb. в скрипте НУЖНО указать адрес сервера с коллектором (в двух местах).
Данному скрипту передается один параметр - что он будет искать dvbs или channels.`

`Пример - ./astra_discovery dvbs вернет json в формате нужном zabbix с двумя макросами по каждому адаптеру {#DVB_ID} и {#DVB_NAME} для channles {#CH_ID}, {#CH_NAME}`


`- astra_mon - забирает статистику. для получения данных нужно передать скрипту три параметра
1 - тип dvb или channel - для чего будем получать данные
2 - id - идинтификатор канала или адаптера
3 - param - параметр, данные которого мы хотим получить (signal, snr, bitrate и т.д.) для signal и snr в скрипте применена формула из рекомендаций cesbo (*100/65535)` 

`astra_stat - получает данные о сессиях. Передать нужно два параметра - реализовано:
astra_stat stat all - получение количества сессий с аптаймом > 5 минут
 astra_stat stat uniqip - количество уникальных сессий на основе IP адреса
 astra_stat channel id - считаем сессии по определенному каналу(id = channel_id).`

[Скачать костыли](https://radiosintetica.ru/content/images/2016/04/Astra+Zabbix2.zip)

